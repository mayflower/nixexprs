From 60e805dd7ca458c663b596139a0a3f98ecee379a Mon Sep 17 00:00:00 2001
From: Robin Gloster <mail@glob.in>
Date: Wed, 10 Jul 2019 17:35:26 +0200
Subject: [PATCH] Improve slack notifications

---
 .../Component/ComponentStatusChangedNotification.php        | 3 +--
 app/Notifications/Incident/NewIncidentNotification.php      | 3 ++-
 .../IncidentUpdate/IncidentUpdatedNotification.php          | 2 +-
 app/Notifications/Schedule/NewScheduleNotification.php      | 6 ++++--
 4 files changed, 8 insertions(+), 6 deletions(-)

diff --git a/app/Notifications/Component/ComponentStatusChangedNotification.php b/app/Notifications/Component/ComponentStatusChangedNotification.php
index 02d02d4a..7c31c580 100644
--- a/app/Notifications/Component/ComponentStatusChangedNotification.php
+++ b/app/Notifications/Component/ComponentStatusChangedNotification.php
@@ -148,8 +148,7 @@ class ComponentStatusChangedNotification extends Notification
                                        'Old Status' => $this->component->human_status,
                                        'New Status' => trans("cachet.components.status.{$this->status}"),
                                        'Link'       => $this->component->link,
-                                   ]))
-                                   ->footer(trans('cachet.subscriber.unsubscribe', ['link' => cachet_route('subscribe.unsubscribe', $notifiable->verify_code)]));
+                                   ]));
                     });
     }
 }
diff --git a/app/Notifications/Incident/NewIncidentNotification.php b/app/Notifications/Incident/NewIncidentNotification.php
index d1ddc601..72c261f7 100644
--- a/app/Notifications/Incident/NewIncidentNotification.php
+++ b/app/Notifications/Incident/NewIncidentNotification.php
@@ -128,7 +128,8 @@ class NewIncidentNotification extends Notification
                     ->$status()
                     ->content($content)
                     ->attachment(function ($attachment) use ($notifiable) {
-                        $attachment->title(trans('notifications.incident.new.slack.title', ['name' => $this->incident->name]))
+                        $url = cachet_route('status-page');
+                        $attachment->title(trans('notifications.incident.new.slack.title', ['name' => $this->incident->name]), $url)
                                    ->timestamp($this->incident->getWrappedObject()->occurred_at)
                                    ->fields(array_filter([
                                        'ID'   => "#{$this->incident->id}",
diff --git a/app/Notifications/IncidentUpdate/IncidentUpdatedNotification.php b/app/Notifications/IncidentUpdate/IncidentUpdatedNotification.php
index c9b5a000..a67802a0 100644
--- a/app/Notifications/IncidentUpdate/IncidentUpdatedNotification.php
+++ b/app/Notifications/IncidentUpdate/IncidentUpdatedNotification.php
@@ -138,7 +138,7 @@ class IncidentUpdatedNotification extends Notification
                         $attachment->title(trans('notifications.incident.update.slack.title', [
                             'name'       => $this->update->incident->name,
                             'new_status' => $this->update->human_status,
-                        ]))
+                        ]), cachet_route('status-page'))
                                    ->timestamp($this->update->getWrappedObject()->created_at)
                                    ->fields(array_filter([
                                        'ID'   => "#{$this->update->id}",
diff --git a/app/Notifications/Schedule/NewScheduleNotification.php b/app/Notifications/Schedule/NewScheduleNotification.php
index 3b04bc67..b560c98e 100644
--- a/app/Notifications/Schedule/NewScheduleNotification.php
+++ b/app/Notifications/Schedule/NewScheduleNotification.php
@@ -119,12 +119,14 @@ class NewScheduleNotification extends Notification implements ShouldQueue
         return (new SlackMessage())
                     ->content(trans('notifications.schedule.new.slack.title'))
                     ->attachment(function ($attachment) use ($content) {
-                        $attachment->title($content)
+                        $attachment->title($content, cachet_route('status-page'))
                                    ->timestamp($this->schedule->getWrappedObject()->scheduled_at)
                                    ->fields(array_filter([
                                        'ID'     => "#{$this->schedule->id}",
                                        'Status' => $this->schedule->human_status,
+                                       'Message' => $this->schedule->message,
                                    ]));
-                    });
+                    })
+                    ->footer($this->schedule->message);
     }
 }
-- 
2.25.1

